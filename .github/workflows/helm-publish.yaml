name: Publish Helm Chart

on:
  workflow_run:
    workflows:
      - Update Helm Chart
    types:
      - completed

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.0

      - name: Add Helm Dependencies
        run: |
          #!/bin/bash

          # Path to your Chart.yaml
          CHART_FILE="charts/immich/Chart.yaml"

          # Check if yq is installed
          if ! command -v yq &> /dev/null; then
            echo "üì¶ Installing yq..."
            sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
            sudo chmod +x /usr/bin/yq
          fi

          # Check if jq is installed
          if ! command -v jq &> /dev/null; then
            echo "üì¶ Installing jq..."
            sudo apt-get install jq
          fi

          # Extract dependencies and add repos
          echo "üîç Extracting Helm dependencies from $CHART_FILE..."
          yq '.dependencies[]' "$CHART_FILE" --output-format json -I0 | \
            yq --input-format json '. | "\(.name) \(.repository)"' | while read -r name repo; do
              # Check if repo is already added
              if helm repo list | grep -q "$repo"; then
                echo "‚úÖ Helm repo '$repo' already added."
              else
                echo "‚ûï Adding Helm repo '$name' from $repo..."
                if ! helm repo add "$repo_name" "$repo"; then
                  echo "‚ö†Ô∏è Warning: Failed to add repo '$repo_name'. Continuing anyway..."
                fi
              fi
          done
          echo "üîÑ Updating Helm repositories..."
          helm repo update

          echo "‚úÖ All dependencies added and updated."

      - name: Add bjw-s-labs
        run: |
          helm repo add common https://bjw-s-labs.github.io/helm-charts

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.7.0
        with:
          skip_existing: true
          packages_with_index: true
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"